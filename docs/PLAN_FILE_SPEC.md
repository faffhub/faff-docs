# Faff Plan File Specification

## Overview

Faff plan files (also called "templates") use TOML format to define reusable work configurations. Plans provide:

- **Vocabulary**: Lists of roles, actions, objectives, and subjects to use
- **Trackers**: Mapping of tracker IDs to human-readable names
- **Pre-defined Intents**: Complete session templates that can be started quickly
- **Validity Period**: Date range for when this plan is applicable

Plans can be:
- **Local**: Stored in `.faff/plans/` directory
- **Remote**: Fetched from URLs via plugins (e.g., Jira, GitHub Projects)

## File Format

### File Extension
`.toml`

### File Naming Convention
Typically named by source, e.g., `local.toml`, `project-alpha.toml`

### Character Encoding
UTF-8

## File Structure

```toml
source      = "local"
valid_from  = "2025-03-01"
valid_until = "2025-03-31"

roles = [
    "engineer",
    "manager",
    "researcher"
]

actions = [
    "coding",
    "reviewing",
    "meeting",
    "planning"
]

objectives = [
    "development",
    "maintenance",
    "quality",
    "coordination"
]

subjects = [
    "features",
    "bugs",
    "documentation",
    "infrastructure"
]

[trackers]
"PROJ-123" = "Fix login bug"
"PROJ-124" = "Add OAuth support"
"PROJ-125" = "Refactor frontend"

[[intents]]
alias     = "standup"
role      = "engineer"
objective = "coordination"
action    = "meeting"
subject   = "team sync"
trackers  = []

[[intents]]
alias     = "feature work"
role      = "engineer"
objective = "development"
action    = "coding"
subject   = "authentication"
trackers  = ["PROJ-123", "PROJ-124"]
```

## Top-Level Fields

### Required Fields

- **`source`** (string): Identifier for where this plan comes from
  - Local plans: Simple name like `"local"`, `"personal"`
  - Remote plans: URL like `"https://api.example.com/plans/project-alpha"`
  - Used to generate plan ID (slugified): `"local"` → `"local"`, `"My Work Plan"` → `"my-work-plan"`

- **`valid_from`** (string): Start date for plan validity
  - Format: ISO 8601 date (`YYYY-MM-DD`)
  - Example: `"2025-03-01"`

### Optional Fields

- **`valid_until`** (string, optional): End date for plan validity
  - Format: ISO 8601 date (`YYYY-MM-DD`)
  - If omitted, plan is valid indefinitely
  - Example: `"2025-03-31"`

- **`roles`** (array of strings): List of available roles
  - Used for autocomplete and validation
  - Example: `["engineer", "manager", "analyst"]`
  - Omitted if empty

- **`actions`** (array of strings): List of available actions
  - Example: `["coding", "testing", "documenting"]`
  - Omitted if empty

- **`objectives`** (array of strings): List of available objectives
  - Example: `["development", "maintenance", "research"]`
  - Omitted if empty

- **`subjects`** (array of strings): List of available subjects
  - Example: `["features", "bugs", "performance"]`
  - Omitted if empty

- **`trackers`** (table): Mapping of tracker IDs to names
  - Key: Tracker ID (e.g., `"PROJ-123"`, `"JIRA-456"`)
  - Value: Human-readable description
  - Example:
    ```toml
    [trackers]
    "PROJ-123" = "Fix critical login bug"
    "PROJ-124" = "Add OAuth2 support"
    ```
  - Omitted if empty

- **`intents`** (array of tables): Pre-defined session templates
  - Each intent is a complete session configuration
  - See [Intent Structure](#intent-structure) below
  - Omitted if empty

## Intent Structure

Each `[[intents]]` entry defines a reusable session template with the same fields as log file sessions:

```toml
[[intents]]
alias     = "work"          # Optional: Short name
role      = "engineer"      # Optional: Your role
objective = "development"   # Optional: What you're achieving
action    = "coding"        # Optional: Activity type
subject   = "features"      # Optional: What you're working on
trackers  = ["PROJ-123"]    # Optional: Project/issue IDs
```

**All intent fields are optional.** If `alias` is not provided, it's auto-generated as:
```
"{role}: {action} to {objective} for {subject}"
```

### Tracker Format in Intents

- **Empty list**: `trackers = []`
- **Single tracker**: `trackers = ["PROJ-123"]`
- **Multiple trackers**: `trackers = ["PROJ-123", "PROJ-124", "PROJ-125"]`
- Trackers are automatically deduplicated

## Plan ID Generation

The plan ID is generated by slugifying the `source`:

| Source | Generated ID |
|--------|-------------|
| `"local"` | `"local"` |
| `"My Work Plan"` | `"my-work-plan"` |
| `"https://example.com/my-plan"` | `"https-example-com-my-plan"` |

Plan IDs are used:
- As filenames for cached plans
- To reference plans in configuration
- In UI/CLI displays

## Validity Period

Plans have an active date range defined by `valid_from` and optional `valid_until`:

```toml
source      = "q1-2025"
valid_from  = "2025-01-01"
valid_until = "2025-03-31"  # Optional
```

**Validity Rules:**
- Plan is active if current date >= `valid_from`
- If `valid_until` is set, plan is active if current date <= `valid_until`
- Multiple plans can be active simultaneously
- Newer plans (by `valid_from`) take precedence for conflicts

## Minimal Plan Example

The absolute minimum valid plan:

```toml
source     = "local"
valid_from = "2025-03-01"
```

This plan:
- Is valid from March 1, 2025 onwards
- Provides no vocabulary or intents
- Is primarily a marker for date-based organization

## Complete Example

```toml
source      = "project-alpha"
valid_from  = "2025-03-01"
valid_until = "2025-06-30"

roles = [
    "engineer",
    "tech-lead",
    "reviewer"
]

actions = [
    "coding",
    "reviewing",
    "meeting",
    "planning",
    "testing"
]

objectives = [
    "development",
    "maintenance",
    "quality",
    "coordination",
    "learning"
]

subjects = [
    "authentication",
    "api",
    "frontend",
    "database",
    "documentation"
]

[trackers]
"ALPHA-101" = "User authentication system"
"ALPHA-102" = "REST API development"
"ALPHA-103" = "Frontend redesign"
"ALPHA-104" = "Database migration"
"ALPHA-105" = "API documentation"

[[intents]]
alias     = "standup"
role      = "engineer"
objective = "coordination"
action    = "meeting"
subject   = "team sync"
trackers  = []

[[intents]]
alias     = "auth work"
role      = "engineer"
objective = "development"
action    = "coding"
subject   = "authentication"
trackers  = ["ALPHA-101"]

[[intents]]
alias     = "api work"
role      = "tech-lead"
objective = "development"
action    = "coding"
subject   = "api"
trackers  = ["ALPHA-102"]

[[intents]]
alias     = "code review"
role      = "reviewer"
objective = "quality"
action    = "reviewing"
subject   = "pull requests"
trackers  = []

[[intents]]
alias     = "frontend"
role      = "engineer"
objective = "development"
action    = "coding"
subject   = "frontend"
trackers  = ["ALPHA-103"]
```

## Remote Plans

Plans can be fetched from remote sources via plugins. The plugin system:

1. **Defines a `source` URL** in configuration:
   ```toml
   [[plan_remote]]
   name   = "jira-project"
   plugin = "jira"

   [plan_remote.config]
   url = "https://company.atlassian.net"
   project = "PROJ"
   ```

2. **Plugin fetches and generates plan** with:
   - `source` set to the plugin identifier
   - `trackers` populated from remote issues/tickets
   - `intents` generated from project structure
   - `valid_from`/`valid_until` based on project dates

3. **Plan is cached locally** in `.faff/plans/{plan_id}.toml`

4. **Auto-updates** when cache expires or on manual refresh

## Usage in Logs

Plans provide vocabulary and templates for log files:

1. **Autocomplete**: CLI suggests values from active plans' vocabulary lists
2. **Tracker Lookup**: Tracker IDs are annotated with names from `[trackers]`
3. **Quick Start**: Intents can be selected to quickly start a session with pre-filled values
4. **Validation**: CLI warns if values don't match any active plan's vocabulary

## Validation Rules

1. `source` must be a non-empty string
2. `valid_from` must be a valid ISO 8601 date
3. If `valid_until` is provided, it must be >= `valid_from`
4. All array fields (roles, actions, objectives, subjects, trackers in intents) must contain strings
5. Tracker IDs in `[trackers]` should match those referenced in `[[intents]]` (warning if not)
6. Intent fields follow same rules as log session intent fields
7. Duplicate intents are automatically deduplicated by content

## File Locations

### Local Plans
```
.faff/
└── plans/
    ├── local.toml
    ├── personal.toml
    └── project-alpha.toml
```

### Cached Remote Plans
```
.faff/
└── plans/
    ├── jira-project-alpha.toml
    └── github-org-repo.toml
```

Plans are loaded in priority order:
1. Newer `valid_from` dates first
2. Local plans before remote plans (if same date)
3. Alphabetically by `source` name (if same date and type)

## See Also

- [Log File Specification](LOG_FILE_SPEC.md)
- [Plugin System Documentation](../core/src/plugins.rs)
- [Intent Model Documentation](../core/src/models/intent.rs)
- [Plan Model Documentation](../core/src/models/plan.rs)
